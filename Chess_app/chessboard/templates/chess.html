{% load staticfiles %}


<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link rel="stylesheet" href="{% static 'css/chessboard-0.3.0.min.css' %}">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="{% static 'js/chessboard-0.3.0.js' %}"></script>
    <script src="{% static 'js/chess.js' %}"></script>
  </head>
  <body>
      <script src="{% static 'js/chess.js' %}"></script>
      <div id="board" style="width: 400px"></div>
      <input type="button" id="moveforme" value="Make move for me" />
      <input type="button" id="moves" value="output move" />

    <script>
        var board,
          game = new Chess()

        // do not pick up pieces if the game is over
        // only pick up pieces for the side to move
        var onDragStart = function(source, piece, position, orientation) {
          if (game.game_over() === true ||
              (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
              (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
          }
        };

        var onDrop = function(source, target) {
          // see if the move is legal
          var move = game.move({
            from: source,
            to: target,
            promotion: 'q' // NOTE: always promote to a queen for example simplicity
          });

          // illegal move
          if (move === null) return 'snapback';

          updateStatus();
        };

        // update the board position after the piece snap
        // for castling, en passant, pawn promotion
        var onSnapEnd = function() {
          board.position(game.fen());
        };

        var updateStatus = function() {
          var status = '';

          var moveColor = 'White';
          if (game.turn() === 'b') {
            moveColor = 'Black';
          }

          // checkmate?
          if (game.in_checkmate() === true) {
            status = 'Game over, ' + moveColor + ' is in checkmate.';
          }

          // draw?
          else if (game.in_draw() === true) {
            status = 'Game over, drawn position';
          }

          // game still on
          else {
            status = moveColor + ' to move';

            // check?
            if (game.in_check() === true) {
              status += ', ' + moveColor + ' is in check';
            }
          }
        };

        $('#moveforme').on('click', function() {
            var list_moves = game.history({verbose: true});
            var alg = "";
            for (i = 0; i < list_moves.length; i++){
                alg += String(i+1) + ". " + list_moves[i].san + " "
            }
            $.ajax({
            url: '{% url "move_generator" %}',
            data: {moves: alg},
            type: 'GET',
            dataType: 'json'
        }).done(function(data) {
            game.move(data.m);
            updateStatus();
            board.position(game.fen());
            });
        });

        $('#moves').on('click', function() {
            var list_moves = game.history({verbose: true});
            var alg = "";
            for (i = 0; i < list_moves.length; i++){
                alg += String(i+1) + ". " + list_moves[i].san + " "
            }
            $.ajax({
            url: '{% url "move_generator" %}',
            data: {moves: alg},
            type: 'GET',
            dataType: 'json'
        }).done(function(data) {
            alert(data.m);
            });
        });


        var cfg = {
          draggable: true,
          position: 'start',
          onDragStart: onDragStart,
          onDrop: onDrop,
          onSnapEnd: onSnapEnd
        };
        board = ChessBoard('board', cfg);

        updateStatus();
    /*
        var game = new Chess();
        var onDragMove = function(newLocation, oldLocation, source,
                                  piece, position, orientation) {
          console.log("New location: " + newLocation);
          console.log("Old location: " + oldLocation);
          console.log("Source: " + source);
          console.log("Piece: " + piece);
          console.log("Position: " + ChessBoard.objToFen(position));
          console.log("Orientation: " + orientation);
          console.log("--------------------");
          game.move({from: oldLocation, to: newLocation});

        };

        $('#History').on('click', function() {
            var list_moves = game.history({verbose: true});
            var alg = "";
            for (i = 0; i < list_moves.length; i++){
                if (list_moves[i].captured != null){
                    alg += String(i+1) + ". " + list_moves[i].san + " "
                } else if (list_moves[i].piece == 'p'){
                    alg += String(i+1) + ". " + list_moves[i].from + " " + list_moves[i].to + " ";
                } else {
                    alg += String(i+1) + ". " + list_moves[i].piece + list_moves[i].from + " " + list_moves.to + " ";
                }
            }
            console.log("moves: " + alg)
        });


        var cfg = {
          draggable: true,
          position: 'start',
          onDragMove: onDragMove,
        };
        var board = ChessBoard('board', cfg);
    */
    </script>
  </body>
</html>
